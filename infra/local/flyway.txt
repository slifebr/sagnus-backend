flyway:
-----------------------------------------------------------------------------------------------------------
1)
para forcar o reset do banco

Flyway Validation & Entity Mapping Fix
Summary
Resolved application startup failures in sagnus-bc-corp caused by:

Flyway Validation Error: Checksum mismatch in migrations requiring a database schema reset.
JPA Mapping Error: 
UnidadeEntity
 incorrectly mapped a nome column that did not exist in the database; corrected to descricao.
Verified
Application starts successfully on port 8080 (or configured port).
Database schema sagnus was successfully recreated.
Helper Snippet
Temporary Flyway Clean Strategy
Use this Bean in your @SpringBootApplication class to force a database clean and migrate on startup. Remove after use.

@org.springframework.context.annotation.Bean
public org.springframework.boot.autoconfigure.flyway.FlywayMigrationStrategy cleanMigrateStrategy() {
    return flyway -> {
        flyway.clean();
        flyway.migrate();
    };
}
-----------------------------------------------------------------------------------------------------------
2)
1. Flyway Conflict Resolution
Problem: NFe module was connecting to the shared sagnus database where 
V1__init_corp_schema.sql
 was applied (by Corp module). NFe code only contained V2-V4, leading to "Applied migration not resolved locally" validation error.
Fix: Isolated NFe's migration history to a separate table and enabled baselining to ignore the existing non-empty schema.
Change: Updated 
application.yml
:
spring:
  flyway:
    table: flyway_schema_history_nfe
    baseline-on-migrate: true
2. JPA Persistence Activation
Problem: The application failed to create 
NfeRepository
 bean. The in-memory adapter (
InMemoryNfeRepositoryAdapter
) was skipped, and the JPA adapter (
NfeJpaRepositoryAdapter
) was conditional on sagnus.nfe.persistence=jpa, which was missing.
Fix: Enabled JPA persistence.
Change: Added to 
application.yml
:
sagnus:
  nfe:
    persistence: jpa
3. Missing Bean Definition (Component Scan)
Problem: Spring Boot failed to automatically scan 
NfeJpaRepository
 and 
NfeEntity
 because they were located in sub-packages deep in the infrastructure layer.
Fix: Explicitly added scanning annotations to the main application class.
Change: Updated 
SagnusNfeApplication.java
:
@EnableJpaRepositories(basePackages = "com.slifesys.sagnus.nfe.infrastructure.persistence.jpa.repository")
@EntityScan(basePackages = "com.slifesys.sagnus.nfe.infrastructure.persistence.jpa.entity")
Constraint: Also enabled spring.main.allow-bean-definition-overriding=true to resolve conflicts between manual and auto-configuration scanning.
4. Missing Gateway Dependency (CorpPessoaGatewayPort)
Problem: The application failed to find a bean for CorpPessoaGatewayPort. The real adapter (
CorpPessoaGatewayAdapter
) was inactive (missing upstream dependency), and the stub adapter (
StubCorpPessoaGatewayAdapter
) was restricted to the local profile and had a conditional check that failed.
Fix:
Removed @ConditionalOnMissingBean from 
StubCorpPessoaGatewayAdapter
 to ensure it loads when the profile is active.
Run Requirement: The application MUST be run with the local profile to activate the stub.
How to Run
To run the NFe module successfully, use the following command (PowerShell):

mvn spring-boot:run "-Dspring-boot.run.jvmArguments=-Dspring.main.allow-bean-definition-overriding=true -Dspring.profiles.active=local"
Or simply:

mvn spring-boot:run -Dspring-boot.run.profiles=local
(Note: verify if overriding property can be moved to 
application.yml
 permanently to simplify this)
 ----------------------------------------------------------------------------------------------------------------
 3)
 
 Tasks
 Locate Flyway migration files in sagnus-bc-corp
 Analyze the V1 migration file
 Determine the cause of the validation failure
 Fix the startup error (likely by adjusting Flyway config or database state)
sagnus-bc-nfe Debugging
 Reproduce Flyway error in 
sagnus-bc-nfe
 Analyze migration files in 
sagnus-bc-nfe
 Fix Flyway error in 
sagnus-bc-nfe
 Disable Flyway in 
sagnus-bc-nfe
 as per user request
 ==========================================================================================================================================
 esolution Summary: Application Startup Fixes (sagnus-bc-corp & sagnus-bc-nfe)
sagnus-bc-corp
Flyway Validation Error: Resolved by temporarily injecting a FlywayMigrationStrategy to force clean() and migrate() on startup.
JPA Mapping Error: Corrected 
UnidadeEntity
 mapping for the nome column (mapped to descricao in DB).
sagnus-bc-nfe
The NFe module faced multiple startup failures due to shared database conflicts and missing configurations. The following fixes were applied:

1. Flyway Conflict Resolution
Problem: NFe module was connecting to the shared sagnus database where 
V1__init_corp_schema.sql
 was applied (by Corp module). NFe code only contained V2-V4, leading to "Applied migration not resolved locally" validation error.
Fix: Isolated NFe's migration history to a separate table and enabled baselining to ignore the existing non-empty schema.
Change: Updated 
application.yml
:
spring:
  flyway:
    table: flyway_schema_history_nfe
    baseline-on-migrate: true
2. JPA Persistence Activation
Problem: The application failed to create 
NfeRepository
 bean. The in-memory adapter (
InMemoryNfeRepositoryAdapter
) was skipped, and the JPA adapter (
NfeJpaRepositoryAdapter
) was conditional on sagnus.nfe.persistence=jpa, which was missing.
Fix: Enabled JPA persistence.
Change: Added to 
application.yml
:
sagnus:
  nfe:
    persistence: jpa
3. Missing Bean Definition (Component Scan)
Problem: Spring Boot failed to automatically scan 
NfeJpaRepository
 and 
NfeEntity
 because they were located in sub-packages deep in the infrastructure layer.
Fix: Explicitly added scanning annotations to the main application class.
Change: Updated 
SagnusNfeApplication.java
:
@EnableJpaRepositories(basePackages = "com.slifesys.sagnus.nfe.infrastructure.persistence.jpa.repository")
@EntityScan(basePackages = "com.slifesys.sagnus.nfe.infrastructure.persistence.jpa.entity")
Constraint: Also enabled spring.main.allow-bean-definition-overriding=true to resolve conflicts between manual and auto-configuration scanning.
4. Missing Gateway Dependency (CorpPessoaGatewayPort)
Problem: The application failed to find a bean for CorpPessoaGatewayPort. The real adapter (
CorpPessoaGatewayAdapter
) was inactive (missing upstream dependency), and the stub adapter (
StubCorpPessoaGatewayAdapter
) was restricted to the local profile and had a conditional check that failed.
Fix:
Removed @ConditionalOnMissingBean from 
StubCorpPessoaGatewayAdapter
 to ensure it loads when the profile is active.
Run Requirement: The application MUST be run with the local profile to activate the stub.
How to Run
To run the NFe module successfully, use the following command (PowerShell):

mvn spring-boot:run "-Dspring-boot.run.jvmArguments=-Dspring.main.allow-bean-definition-overriding=true -Dspring.profiles.active=local"
Or simply:

mvn spring-boot:run -Dspring-boot.run.profiles=local
(Note: verify if overriding property can be moved to 
application.yml
 permanently to simplify this)
 ==========================================================================================================================================
 ==========================================================================================================================================
 Resolution Summary: Application Startup Fixes (sagnus-bc-corp & sagnus-bc-nfe)
sagnus-bc-corp
Flyway Validation Error: Resolved by temporarily injecting a FlywayMigrationStrategy to force clean() and migrate() on startup.
JPA Mapping Error: Corrected 
UnidadeEntity
 mapping for the nome column (mapped to descricao in DB).
sagnus-bc-nfe
The NFe module faced multiple startup failures due to shared database conflicts and missing configurations. The following fixes were applied:

1. Flyway Conflict Resolution
Problem: NFe module was connecting to the shared sagnus database where 
V1__init_corp_schema.sql
 was applied (by Corp module). NFe code only contained V2-V4, leading to "Applied migration not resolved locally" validation error.
Fix: Isolated NFe's migration history to a separate table and enabled baselining to ignore the existing non-empty schema.
Change: Updated 
application.yml
:
spring:
  flyway:
    table: flyway_schema_history_nfe
    baseline-on-migrate: true
2. JPA Persistence Activation
Problem: The application failed to create 
NfeRepository
 bean. The in-memory adapter (
InMemoryNfeRepositoryAdapter
) was skipped, and the JPA adapter (
NfeJpaRepositoryAdapter
) was conditional on sagnus.nfe.persistence=jpa, which was missing.
Fix: Enabled JPA persistence.
Change: Added to 
application.yml
:
sagnus:
  nfe:
    persistence: jpa
3. Missing Bean Definition (Component Scan)
Problem: Spring Boot failed to automatically scan 
NfeJpaRepository
 and 
NfeEntity
 because they were located in sub-packages deep in the infrastructure layer.
Fix: Explicitly added scanning annotations to the main application class.
Change: Updated 
SagnusNfeApplication.java
:
@EnableJpaRepositories(basePackages = "com.slifesys.sagnus.nfe.infrastructure.persistence.jpa.repository")
@EntityScan(basePackages = "com.slifesys.sagnus.nfe.infrastructure.persistence.jpa.entity")
Constraint: Also enabled spring.main.allow-bean-definition-overriding=true to resolve conflicts between manual and auto-configuration scanning.
4. Missing Gateway Dependency (CorpPessoaGatewayPort)
Problem: The application failed to find a bean for CorpPessoaGatewayPort. The real adapter (
CorpPessoaGatewayAdapter
) was inactive (missing upstream dependency), and the stub adapter (
StubCorpPessoaGatewayAdapter
) was restricted to the local profile and had a conditional check that failed.
Fix:
Removed @ConditionalOnMissingBean from 
StubCorpPessoaGatewayAdapter
 to ensure it loads when the profile is active.
Run Requirement: The application MUST be run with the local profile to activate the stub.
How to Run
To run the NFe module successfully, use the following command (PowerShell):

mvn spring-boot:run "-Dspring-boot.run.jvmArguments=-Dspring.main.allow-bean-definition-overriding=true -Dspring.profiles.active=local"
Or simply:

mvn spring-boot:run -Dspring-boot.run.profiles=local
(Note: verify if overriding property can be moved to 
application.yml
 permanently to simplify this)

User Update: Disable NFe Flyway
Per user request, Flyway has been completely disabled for 
sagnus-bc-nfe
.

Change: Updated 
application.yml
:
spring:
  flyway:
    enabled: false #(Previously: table: flyway_schema_history_nfe)
sagnus-bc-auth Debugging
The 
sagnus-bc-auth
 module failed to start due to multiple configuration issues.

1. YAML Syntax Error
Problem: 
application.yml
 contained an invalid line spring.profiles.active=local inside a YAML block, causing ParserException.
Fix: Commented out the invalid line. The profile defaults to local.
2. Missing Stub for Corp Dependency
Problem: 
sagnus-bc-auth
 depends on 
CorpPessoaQueryPort
 (from Corp module) but running in isolation means no implementation is available.
Fix: Created 
StubCorpPessoaQueryPort
 in com.slifesys.sagnus.auth.infrastructure.integration active for local profile.
3. Missing Component Scan
Problem: JwtUtils bean (from sagnus-platform-security) was not found because 
SagnusAuthApplication
 only scanned the auth package.
Fix: Added @ComponentScan("com.slifesys.sagnus") to 
SagnusAuthApplication.java
.
4. [BLOCKER] Conflicting Bean Definitions
Problem: ConflictingBeanDefinitionException persists between:
com.slifesys.sagnus.platform.error.GlobalExceptionHandler (from platform-web)
com.slifesys.sagnus.shared.error.GlobalExceptionHandler (from shared-api-error)
Both beans default to the name globalExceptionHandler. Attempts to rename the bean in platform-web or exclude it via regex failed, likely due to Maven local repository caching or dependency version mismatch (
sagnus-bc-auth
 seemingly loading an old version of the class).
Status: The module currently fails to start with this conflict. A clean rebuild of the entire project environment is recommended.
